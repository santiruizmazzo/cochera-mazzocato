name: CI/CD Pipeline

# Trigger del workflow
on:
  push:
    branches: [ main, test, dev ]
    paths:
      - backend/**

defaults:
  run:
    working-directory: backend

env:
  GO_VERSION: '1.24'

jobs:
  build:
    name: Build, Lint & Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
    
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/go/pkg/mod
          ~/.cache/go-build
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: Download dependencies
      run: |
        pwd && ls
        go mod download
    
    - name: Verify dependencies
      run: go mod verify

    - name: Build API
      run: |
        echo "Building Go API..."
        go build -v -o api ./cmd/server/main.go
        echo "Build successful!"
    
    - name: Run linter
      uses: golangci/golangci-lint-action@v8
      with:
        version: latest
        args: --timeout=5m
        working-directory: backend
    
    - name: Run unit tests
      run: |
        echo "Running unit tests..."
        go test -v -short -race -cover ./...
    
    - name: Run integration tests
      run: |
        echo "Running integration tests..."
        go test -v -run Integration -cover ./...
  
  test-deploy:
    name: Deploy to Test Environment
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/test'
    
    env:
      DEPLOY_URL: ${{ secrets.TEST_API_DEPLOY_HOOK }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to test server
      run: |
        echo "Deploying to test environment..."
        echo "Binary size: $(ls -lh api)"
        curl "$DEPLOY_URL"
        echo "âœ… Deployment to test environment completed!"